{% extends "base.html" %}
{% block html_lang %}{{ page.lang }}{% endblock %}
{% block title %}{{ page.title|striptags }} | {{ SITENAME|striptags }}{% endblock %}

{% block meta_description %}{% if page.description %}{{ page.description }}{% else %}Glen Striders monthly running challenges and leaderboards. Each month we set a unique named challenge ‚Äì compete with fellow club members!{% endif %}{% endblock %}
{% block meta_keywords %}running challenges leaderboard Harare, Glen Striders monthly challenge, elevation challenge Zimbabwe, Strava running club{% endblock %}

{% block extra_head %}
  {% import 'translations.html' as translations with context %}
  {% if translations.entry_hreflang(page) %}
    {{ translations.entry_hreflang(page) }}
  {% endif %}
{% endblock %}

{% block hero %}{% endblock %}
{% block home_sections %}{% endblock %}

{% block content %}
<!-- Hidden source content for JavaScript parsing -->
<div id="page-content-source" style="display:none;">
  {{ page.content }}
</div>

<!-- Challenges Page -->
<section id="challenges" class="about section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">

    <!-- Page Title -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-8 text-center" data-aos="fade-up" data-aos-delay="200">
        <h2 class="section-heading">Glen Striders Challenges</h2>
        <p class="lead">Each month we set a unique named challenge. Compete with your fellow club members ‚Äî leaderboards are refreshed from Strava once or twice a week.</p>
        <p class="text-muted small">Last updated: {{ page.date.strftime('%d %B %Y') }}</p>
      </div>
    </div>

    <!-- Challenge Tabs -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-10">
        <ul class="challenges-tabs" id="challenges-tabs" role="tablist">
          <!-- Tabs injected by JavaScript -->
        </ul>
      </div>
    </div>

    <!-- Leaderboard Panels -->
    <div class="row justify-content-center">
      <div class="col-lg-10" id="challenges-panels">
        <!-- Panels injected by JavaScript -->
      </div>
    </div>

    <!-- Strava Attribution (required by Strava API Terms) -->
    <div class="row justify-content-center mt-4">
      <div class="col-lg-10 text-center">
        <a href="https://www.strava.com" target="_blank" rel="noopener noreferrer" class="strava-attribution" aria-label="Powered by Strava">
          <svg class="strava-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-hidden="true" focusable="false">
            <path fill="#FC4C02" d="M41.03 47.846l-5.572-10.976h-8.172L41.03 64l13.74-27.13h-8.16z"/>
            <path fill="#FC4C02" d="M27.898 20.126l7.564 14.944h11.062L27.898 0 9.23 35.07h11.048z"/>
          </svg>
          <span>Powered by Strava</span>
        </a>
      </div>
    </div>

  </div>
</section>

<style>
/* ‚îÄ‚îÄ Challenges Tabs ‚îÄ‚îÄ */
.challenges-tabs {
  list-style: none;
  padding: 0;
  margin: 0 0 2rem 0;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
}

.challenges-tabs li button {
  padding: 0.55rem 1.25rem;
  border: 2px solid var(--accent-color);
  background: transparent;
  color: var(--accent-color);
  border-radius: 50px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  font-size: 0.95rem;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

.challenges-tabs li button:hover,
.challenges-tabs li button.active {
  background: var(--accent-color);
  color: #fff;
}

/* ‚îÄ‚îÄ Status badges ‚îÄ‚îÄ */
.badge-current {
  display: inline-block;
  background: #28a745;
  color: #fff;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  padding: 0.15rem 0.5rem;
  border-radius: 50px;
  text-transform: uppercase;
  vertical-align: middle;
}

.badge-past {
  display: inline-block;
  background: #6c757d;
  color: #fff;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  padding: 0.15rem 0.5rem;
  border-radius: 50px;
  text-transform: uppercase;
  vertical-align: middle;
}

/* ‚îÄ‚îÄ Challenge header ‚îÄ‚îÄ */
.challenge-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 1.25rem;
}

.challenge-type-icon {
  font-size: 2.5rem;
  line-height: 1;
  flex-shrink: 0;
}

.challenge-header-text h3 {
  margin: 0 0 0.25rem 0;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--heading-color);
}

.challenge-type-badge {
  display: inline-block;
  background: color-mix(in srgb, var(--accent-color), transparent 85%);
  color: var(--accent-color);
  font-size: 0.8rem;
  font-weight: 600;
  padding: 0.2rem 0.65rem;
  border-radius: 50px;
}

/* ‚îÄ‚îÄ Challenge Panel ‚îÄ‚îÄ */
.challenge-panel {
  display: none;
}

.challenge-panel.active {
  display: block;
}

/* ‚îÄ‚îÄ Challenge Meta (period / goal) ‚îÄ‚îÄ */
.challenge-meta {
  background: color-mix(in srgb, var(--accent-color), transparent 92%);
  border-left: 4px solid var(--accent-color);
  border-radius: 0 8px 8px 0;
  padding: 0.85rem 1.25rem;
  margin-bottom: 1.5rem;
  font-size: 0.95rem;
}

.challenge-meta p {
  margin: 0;
  line-height: 1.7;
}

/* ‚îÄ‚îÄ Podium (top 3) ‚îÄ‚îÄ */
.podium {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 1rem;
  margin-bottom: 2rem;
}

.podium-place {
  text-align: center;
  flex: 1;
  max-width: 180px;
}

.podium-place .medal {
  font-size: 2.4rem;
  display: block;
  margin-bottom: 0.25rem;
}

.podium-place .athlete-name {
  font-weight: 700;
  font-size: 1rem;
  color: var(--heading-color);
  word-break: break-word;
  margin-bottom: 0.15rem;
}

.podium-place .athlete-value {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--accent-color);
  margin-bottom: 0.1rem;
}

.podium-place .athlete-sub {
  font-size: 0.8rem;
  color: #6c757d;
}

.podium-place .podium-block {
  border-radius: 8px 8px 0 0;
  margin-top: 0.5rem;
}

.podium-place.first  .podium-block { background: #ffd700; height: 80px; }
.podium-place.second .podium-block { background: #c0c0c0; height: 60px; }
.podium-place.third  .podium-block { background: #cd7f32; height: 45px; }

/* ‚îÄ‚îÄ Full Leaderboard Table ‚îÄ‚îÄ */
.leaderboard-table-container {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
}

.leaderboard-table thead {
  background: var(--accent-color);
  color: #fff;
}

.leaderboard-table th {
  padding: 0.9rem 1rem;
  text-align: left;
  font-weight: 600;
}

.leaderboard-table td {
  padding: 0.7rem 1rem;
  border-bottom: 1px solid #f0f0f0;
}

.leaderboard-table tbody tr:last-child td {
  border-bottom: none;
}

.leaderboard-table tbody tr:hover {
  background: color-mix(in srgb, var(--accent-color), transparent 94%);
  transition: background 0.2s ease;
}

.rank-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  font-weight: 700;
  font-size: 0.85rem;
  background: #e9ecef;
  color: #495057;
}

.rank-badge.gold   { background: #ffd700; color: #7a5f00; }
.rank-badge.silver { background: #c0c0c0; color: #4a4a4a; }
.rank-badge.bronze { background: #cd7f32; color: #fff; }

/* ‚îÄ‚îÄ Strava Attribution ‚îÄ‚îÄ */
.strava-attribution {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
  color: #FC4C02;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 0.4rem 0.9rem;
  border: 2px solid #FC4C02;
  border-radius: 50px;
  transition: all 0.2s ease;
}

.strava-attribution:hover {
  background: #FC4C02;
  color: #fff;
}

.strava-attribution:hover .strava-logo path {
  fill: #fff;
}

.strava-logo {
  width: 22px;
  height: 22px;
  flex-shrink: 0;
  transition: fill 0.2s ease;
}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .challenge-header { gap: 0.65rem; }
  .challenge-type-icon { font-size: 2rem; }
  .challenge-header-text h3 { font-size: 1.15rem; }

  .podium { gap: 0.5rem; }
  .podium-place .medal { font-size: 1.8rem; }
  .podium-place .athlete-value { font-size: 1.2rem; }
  .podium-place .athlete-name  { font-size: 0.85rem; }

  .leaderboard-table { font-size: 0.88rem; }
  .leaderboard-table th,
  .leaderboard-table td { padding: 0.5rem 0.65rem; }
}
</style>

<script>
(function () {
  'use strict';

  /** Map a challenge Type string to an emoji icon */
  var TYPE_ICONS = {
    'elevation':              'üèîÔ∏è',
    'distance':               'üèÉ',
    'single activity distance': '‚ö°',
    'activities':             'üìÖ',
    'speed':                  'üí®',
    'longest run':            'üó∫Ô∏è'
  };

  function typeIcon(typeStr) {
    if (!typeStr) return 'üèÜ';
    var key = typeStr.toLowerCase().trim();
    return TYPE_ICONS[key] || 'üèÜ';
  }

  /**
   * Parse every H2 section in the hidden content div as one challenge.
   * Recognised meta line prefixes (bold labels):
   *   Challenge Period, Goal, Type, Status
   */
  function parseChallenges() {
    var src = document.getElementById('page-content-source');
    if (!src) return [];

    var challenges = [];
    var clone = src.cloneNode(true);
    var children = Array.from(clone.children);
    var current = null;

    children.forEach(function (el) {
      if (el.tagName === 'H2') {
        if (current) challenges.push(current);
        current = { title: el.textContent.trim(), meta: {}, metaHtml: [], table: null };
      } else if (current) {
        if (el.tagName === 'P') {
          // Try to extract key: value from bold labels
          var strongs = el.querySelectorAll('strong');
          strongs.forEach(function (s) {
            var key = s.textContent.replace(':', '').trim().toLowerCase();
            // value is the text that follows the <strong> in the same <p>
            var val = s.nextSibling ? s.nextSibling.textContent.trim() : '';
            if (key && val) current.meta[key] = val;
          });
          current.metaHtml.push(el.innerHTML.trim());
        } else if (el.tagName === 'TABLE' && !current.table) {
          current.table = el;
        }
      }
    });
    if (current) challenges.push(current);

    return challenges;
  }

  /** Build a full challenge panel */
  function buildPanel(challenge, index) {
    var panel = document.createElement('div');
    panel.className = 'challenge-panel' + (index === 0 ? ' active' : '');
    panel.id = 'panel-' + index;

    var status   = (challenge.meta['status'] || '').toLowerCase();
    var typeStr  = challenge.meta['type'] || '';

    // ‚îÄ‚îÄ Challenge header ‚îÄ‚îÄ
    var header = document.createElement('div');
    header.className = 'challenge-header';

    var iconSpan = document.createElement('span');
    iconSpan.className = 'challenge-type-icon';
    iconSpan.textContent = typeIcon(typeStr);
    header.appendChild(iconSpan);

    var textDiv = document.createElement('div');
    textDiv.className = 'challenge-header-text';

    var titleEl = document.createElement('h3');
    titleEl.textContent = challenge.title;
    textDiv.appendChild(titleEl);

    if (typeStr) {
      var typeBadge = document.createElement('span');
      typeBadge.className = 'challenge-type-badge';
      typeBadge.textContent = typeStr;
      textDiv.appendChild(typeBadge);
    }
    header.appendChild(textDiv);

    // Status badge (current / past)
    if (status) {
      var statusBadge = document.createElement('span');
      statusBadge.className = status === 'current' ? 'badge-current' : 'badge-past';
      statusBadge.textContent = status === 'current' ? 'üü¢ Current' : 'Past';
      header.appendChild(statusBadge);
    }

    panel.appendChild(header);

    // ‚îÄ‚îÄ Meta block (period + goal, skip Type/Status lines) ‚îÄ‚îÄ
    var metaLines = challenge.metaHtml.filter(function (html) {
      var lower = html.toLowerCase();
      return lower.indexOf('<strong>type') === -1 && lower.indexOf('<strong>status') === -1;
    });

    if (metaLines.length) {
      var meta = document.createElement('div');
      meta.className = 'challenge-meta';
      metaLines.forEach(function (html) {
        var p = document.createElement('p');
        p.innerHTML = html;
        meta.appendChild(p);
      });
      panel.appendChild(meta);
    }

    // ‚îÄ‚îÄ No data message ‚îÄ‚îÄ
    if (!challenge.table) {
      var noData = document.createElement('p');
      noData.textContent = 'No leaderboard data available yet. Check back after the next Strava sync.';
      panel.appendChild(noData);
      return panel;
    }

    var headerCells = Array.from(challenge.table.querySelectorAll('thead th'));
    var headers = headerCells.map(function (th) { return th.textContent.trim(); });
    var rows = Array.from(challenge.table.querySelectorAll('tbody tr'));

    var athletes = rows.map(function (row) {
      var cells = Array.from(row.querySelectorAll('td'));
      return cells.map(function (td) { return td.textContent.trim(); });
    }).filter(function (r) { return r.length >= 2; });

    // ‚îÄ‚îÄ Podium (top 3) ‚îÄ‚îÄ
    if (athletes.length >= 3 && headers.length >= 3) {
      var podiumDiv = document.createElement('div');
      podiumDiv.className = 'podium';

      var order   = [1, 0, 2];
      var classes = ['second', 'first', 'third'];
      var medals  = ['ü•à', 'ü•á', 'ü•â'];
      var subHeader = headers[3] ? headers[3] : '';

      order.forEach(function (pos, i) {
        if (!athletes[pos]) return;
        var a = athletes[pos];
        var place = document.createElement('div');
        place.className = 'podium-place ' + classes[i];

        var nameVal = a[1] || '';
        var mainVal = a[2] || '';
        var subVal  = (a[3] !== undefined && subHeader) ? subHeader + ': ' + a[3] : '';

        place.innerHTML =
          '<span class="medal">' + medals[i] + '</span>' +
          '<div class="athlete-name">' + escHtml(nameVal) + '</div>' +
          '<div class="athlete-value">' + escHtml(mainVal) + '</div>' +
          '<div class="athlete-sub">' + escHtml(subVal) + '</div>' +
          '<div class="podium-block"></div>';

        podiumDiv.appendChild(place);
      });

      panel.appendChild(podiumDiv);
    }

    // ‚îÄ‚îÄ Full leaderboard table ‚îÄ‚îÄ
    var tableWrap = document.createElement('div');
    tableWrap.className = 'leaderboard-table-container';

    var table = document.createElement('table');
    table.className = 'leaderboard-table';

    var thead = document.createElement('thead');
    var headRow = document.createElement('tr');
    headers.forEach(function (h) {
      var th = document.createElement('th');
      th.textContent = h;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    athletes.forEach(function (a, idx) {
      var tr = document.createElement('tr');
      a.forEach(function (cell, ci) {
        var td = document.createElement('td');
        if (ci === 0) {
          var badge = document.createElement('span');
          badge.className = 'rank-badge' + (idx === 0 ? ' gold' : idx === 1 ? ' silver' : idx === 2 ? ' bronze' : '');
          badge.textContent = cell;
          td.appendChild(badge);
        } else {
          td.textContent = cell;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    tableWrap.appendChild(table);
    panel.appendChild(tableWrap);

    return panel;
  }

  function escHtml(str) {
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', function () {
    var challenges = parseChallenges();
    var tabsList  = document.getElementById('challenges-tabs');
    var panelsCtr = document.getElementById('challenges-panels');

    if (!challenges.length) {
      panelsCtr.innerHTML = '<p class="text-center">No challenges found.</p>';
      return;
    }

    challenges.forEach(function (ch, i) {
      var status = (ch.meta['status'] || '').toLowerCase();

      // Tab button
      var li = document.createElement('li');
      li.setAttribute('role', 'presentation');
      var btn = document.createElement('button');
      btn.setAttribute('role', 'tab');
      btn.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
      if (i === 0) btn.classList.add('active');

      // Add status dot to tab label
      if (status === 'current') {
        var dot = document.createElement('span');
        dot.textContent = 'üü¢';
        dot.style.fontSize = '0.7rem';
        btn.appendChild(dot);
      }
      var labelNode = document.createTextNode(ch.title);
      btn.appendChild(labelNode);

      btn.addEventListener('click', function () {
        tabsList.querySelectorAll('button').forEach(function (b) {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        panelsCtr.querySelectorAll('.challenge-panel').forEach(function (p) {
          p.classList.remove('active');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        document.getElementById('panel-' + i).classList.add('active');
      });

      li.appendChild(btn);
      tabsList.appendChild(li);

      // Panel
      panelsCtr.appendChild(buildPanel(ch, i));
    });
  });
}());
</script>
{% endblock %}

